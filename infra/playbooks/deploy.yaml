# ANSIBLE_PASSWORD
# ANSIBLE_USER
# git_pat
# git_username
# MAILERCFW_API_KEY
# CLOUDFLARED_SECRET
- hosts: ezconnectvm.ruibin.me
  tasks:
    - name: Update ezConnect repository
      git:
        repo: https://{{ git_username }}:{{ git_pat }}@github.com/camille-readbean/ezConnect.git
        dest: /home/azureuser/ezConnect
        update: yes
        version: prepms2

    - name: Update and upgrade apt packages
      become: true
      apt:
        upgrade: yes
        update_cache: yes
        cache_valid_time: 86400 #One day

    - name: Install aptitude
      become: true
      apt:
        name: aptitude
        state: latest
        update_cache: true

    - name: Install required system packages
      become: true
      apt:
        pkg:
          - apt-transport-https
          - ca-certificates
          - curl
          - software-properties-common
          - python3-pip
          - virtualenv
          - python3-setuptools
        state: latest
        update_cache: true
    
    - name: Add Docker GPG apt Key
      become: true
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker Repository
      become: true
      apt_repository:
        repo: deb https://download.docker.com/linux/ubuntu focal stable
        state: present

    - name: Update apt and install docker-ce
      become: true
      apt:
        name: docker-ce
        state: latest
        update_cache: true

    # Server need docker module
    - name: Install docker Python library
      become: true
      pip:
        name: 
          - docker
          - docker-compose

    - name: Change to frontend directory and build
      # become: true
      # shell: cd ezConnect/frontend/; curl -sL https://deb.nodesource.com/setup_18.x | sudo -E bash - && sudo apt-get install -y nodejs && npm install && npm run build; cd ..; 
      shell: cd ezConnect/frontend/; npm install; npm run build; cd ..; 

    - name: Build and start services
      become: true
      environment :
        MAILERCFW_API_KEY: "{{ MAILERCFW_API_KEY }}"
        CLOUDFLARED_SECRET: "{{ CLOUDFLARED_SECRET }}"
      docker_compose:
        project_src: /home/azureuser/ezConnect
        files:
          - docker-compose.yml
        state: present
        build: yes
      # shell: cd ezConnect/; docker compose --file infra/docker-compose.prod.